Author: Andrew Rathbun
Description: The database engine detached a database
EventId: 327
Channel: "Application"
Provider: ESENT
Maps:
  -
    Property: PayloadData1
    PropertyValue: "%FilePath%"
    Values:
      -
        Name: FilePath
        Value: "/Event/EventData/Data"
        Refine: "(?>\b[A-Za-z]:|\\\\[a-zA-Z0-9 %._~-]{1,63}\\[a-zA-Z0-9 $%._~-]{1,80})\\(?>[^\\\/:<>|\x00-\x1F]{0,254}[^.\\\/:*?"<>|\x00-\x1F]\\)*(?>[^\\\/:*?"<>|\x00-\x1F]{0,254}[^,\d.\s\\\/:*?"<>|\x00-\x1F])"
  -
    Property: PayloadData2
    PropertyValue: "%DatabaseName%"
    Values:
      -
        Name: DatabaseName
        Value: "/Event/EventData/Data
        Refine: "(?<=)[^,\\d]+(?=,)"


# Documentation:
# https://docs.microsoft.com/en-us/troubleshoot/windows-server/performance/esent-event-327-326
# https://blog.menasec.net/2019/11/forensics-traces-of-ntdsdit-dumping.html
# https://sadomovalex.blogspot.com/2013/10/fix-problem-with-flooded-event-viewer.html
# https://kiransawant.wordpress.com/2016/07/20/event-source-esent-with-event-id-327-and-326-occur-in-large-amounts/
#
# Example Event Data:
# <Event>
#   <System>
#     <Provider Name="ESENT" />
#     <EventID Qualifiers="0">327</EventID>
#     <Level>4</Level>
#     <Task>1</Task>
#     <Keywords>0x80000000000000</Keywords>
#     <TimeCreated SystemTime="2021-03-10 10:39:13.0678953" />
#     <EventRecordID>114232</EventRecordID>
#     <Channel>Application</Channel>
#     <Computer>HOSTNAME.domain</Computer>
#     <Security />
#   </System>
#   <EventData>
#     <Data>NTDS, 1234,D,100, 2, c:\temp_logs\Active Directory\ntds.dit, 0,
# [1] 0.000004 +J(0)
# [2] 0.0 +J(0)
# [3] 0.000015 +J(0) +M(C:0K, Fs:1, WS:4K # 0K, PF:0K # 0K, P:0K)
# [4] 0.0 +J(0)
# [5] 0.0 +J(0)
# [6] 0.438081 -0.314307 (25) WT +J(0) +M(C:-2636K, Fs:236, WS:-1704K # 0K, PF:-1464K # 0K, P:-1464K)
# [7] 0.004210 +J(0)
# [8] 0.000046 +J(0)
# [9] 0.037577 -0.016833 (6) WT +J(0) +M(C:0K, Fs:9, WS:-44K # 0K, PF:-48K # 0K, P:-48K)
# [10] 0.006183 +J(0)
# [11] 0.000090 +J(0) +M(C:0K, Fs:0, WS:-8K # 0K, PF:-8K # 0K, P:-8K)., 0 0</Data>
#     <Binary></Binary>
#   </EventData>
# </Event>
